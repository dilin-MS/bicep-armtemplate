{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.63.48766",
      "templateHash": "14015848724199677075"
    }
  },
  "parameters": {
    "resourceGroupName": {
      "type": "string"
    },
    "tenantId": {
      "type": "string"
    },
    "AADClientId": {
      "type": "string"
    },
    "AADClientSecret": {
      "type": "secureString"
    },
    "frontendHosting_storageName": {
      "type": "string",
      "defaultValue": "[format('frontendstg{0}', uniqueString(parameters('resourceGroupName')))]",
      "metadata": {
        "description": "Name of Storage Accounts for frontend hosting."
      },
      "maxLength": 24,
      "minLength": 3
    },
    "function_serverfarmsName": {
      "type": "string",
      "defaultValue": "[format('{0}-function-serverfarms', parameters('resourceGroupName'))]"
    },
    "function_webappName": {
      "type": "string",
      "defaultValue": "[format('{0}-function-webapp', parameters('resourceGroupName'))]"
    },
    "function_storageName": {
      "type": "string",
      "defaultValue": "[format('functionstg{0}', uniqueString(parameters('resourceGroupName')))]",
      "metadata": {
        "description": "Name of Storage Accounts for function backend."
      },
      "maxLength": 24,
      "minLength": 3
    },
    "simpleAuth_sku": {
      "type": "string"
    },
    "simpleAuth_serverFarmsName": {
      "type": "string",
      "defaultValue": "[format('{0}-simpleAuth-serverfarms', parameters('resourceGroupName'))]"
    },
    "simpleAuth_webAppName": {
      "type": "string",
      "defaultValue": "[format('{0}-simpleAuth-webapp', parameters('resourceGroupName'))]"
    }
  },
  "functions": [],
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "frontendHostingDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "frontend_hosting_storage_name": {
            "value": "[parameters('frontendHosting_storageName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.63.48766",
              "templateHash": "14244182860703259764"
            }
          },
          "parameters": {
            "frontend_hosting_storage_name": {
              "type": "string",
              "metadata": {
                "description": "Name of Storage Accounts for frontend hosting."
              },
              "maxLength": 24,
              "minLength": 3
            }
          },
          "functions": [],
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('frontend_hosting_storage_name')]",
              "kind": "StorageV2",
              "location": "[resourceGroup().location]",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "isHnsEnabled": false
              },
              "sku": {
                "name": "Standard_LRS"
              }
            }
          ],
          "outputs": {
            "connectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('frontend_hosting_storage_name'), listKeys(resourceId(resourceGroup().name, 'Microsoft.Storage/storageAccounts', parameters('frontend_hosting_storage_name')), '2019-04-01').keys[0].value, environment().suffixes.storage)]"
            },
            "storageName": {
              "type": "string",
              "value": "[parameters('frontend_hosting_storage_name')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('frontend_hosting_storage_name'))).primaryEndpoints.web]"
            },
            "domain": {
              "type": "string",
              "value": "[replace(replace(reference(resourceId('Microsoft.Storage/storageAccounts', parameters('frontend_hosting_storage_name'))).primaryEndpoints.web, 'https://', ''), '/', '')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "functionDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[parameters('function_webappName')]"
          },
          "functionServerfarmsName": {
            "value": "[parameters('function_serverfarmsName')]"
          },
          "functionStorageName": {
            "value": "[parameters('function_storageName')]"
          },
          "AADClientId": {
            "value": "[parameters('AADClientId')]"
          },
          "AADClientSecret": {
            "value": "[parameters('AADClientSecret')]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "applicationIdUri": {
            "value": "[format('api://{0}/{1}', reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.domain.value, parameters('AADClientId'))]"
          },
          "frontendHostingStorageEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.endpoint.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.63.48766",
              "templateHash": "15401985794822256904"
            }
          },
          "parameters": {
            "functionServerfarmsName": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "functionStorageName": {
              "type": "string",
              "metadata": {
                "description": "Name of Storage Accounts for function backend."
              },
              "maxLength": 24,
              "minLength": 3
            },
            "AADClientId": {
              "type": "string"
            },
            "AADClientSecret": {
              "type": "secureString"
            },
            "tenantId": {
              "type": "string"
            },
            "applicationIdUri": {
              "type": "string"
            },
            "frontendHostingStorageEndpoint": {
              "type": "string"
            }
          },
          "functions": [],
          "variables": {
            "oauthAuthorityHost": "[environment().authentication.loginEndpoint]",
            "teamsAadIds": "1fec8e78-bce4-4aaf-ab1b-5451cc387264;5e3ce6c0-2b1f-4285-8d4b-75ee78787346",
            "oauthAuthority": "[uri(variables('oauthAuthorityHost'), parameters('tenantId'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2020-06-01",
              "name": "[parameters('functionServerfarmsName')]",
              "location": "[resourceGroup().location]",
              "sku": {
                "name": "Y1"
              },
              "kind": "functionapp",
              "properties": {
                "reserved": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-06-01",
              "name": "[parameters('functionAppName')]",
              "kind": "functionapp",
              "location": "[resourceGroup().location]",
              "properties": {
                "reserved": false,
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('functionServerfarmsName'))]",
                "siteConfig": {
                  "cors": {
                    "allowedOrigins": [
                      "[parameters('frontendHostingStorageEndpoint')]"
                    ]
                  },
                  "alwaysOn": false,
                  "http20Enabled": false,
                  "numberOfWorkers": 1
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('functionServerfarmsName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('functionStorageName')]",
              "kind": "StorageV2",
              "location": "[resourceGroup().location]",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "isHnsEnabled": true
              },
              "sku": {
                "name": "Standard_LRS"
              }
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2018-02-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'appsettings')]",
              "properties": {
                "API_ENDPOINT": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName'))).hostNames[0]]",
                "ALLOWED_APP_IDS": "[variables('teamsAadIds')]",
                "AzureWebJobsDashboard": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('functionStorageName'), listKeys(resourceId(resourceGroup().name, 'Microsoft.Storage/storageAccounts', parameters('functionStorageName')), '2019-04-01').keys[0].value, environment().suffixes.storage)]",
                "AzureWebJobsStorage": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('functionStorageName'), listKeys(resourceId(resourceGroup().name, 'Microsoft.Storage/storageAccounts', parameters('functionStorageName')), '2019-04-01').keys[0].value, environment().suffixes.storage)]",
                "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('functionStorageName'), listKeys(resourceId(resourceGroup().name, 'Microsoft.Storage/storageAccounts', parameters('functionStorageName')), '2019-04-01').keys[0].value, environment().suffixes.storage)]",
                "WEBSITE_NODE_DEFAULT_VERSION": "~12",
                "WEBSITE_RUN_FROM_PACKAGE": "1",
                "WEBSITE_CONTENTSHARE": "[toLower(parameters('functionAppName'))]",
                "FUNCTIONS_EXTENSION_VERSION": "~3",
                "FUNCTIONS_WORKER_RUNTIME": "node",
                "M365_APPLICATION_ID_URI": "[parameters('applicationIdUri')]",
                "M365_CLIENT_ID": "[parameters('AADClientId')]",
                "M365_CLIENT_SECRET": "[parameters('AADClientSecret')]",
                "M365_TENANT_ID": "[parameters('tenantId')]",
                "M365_AUTHORITY_HOST": "[variables('oauthAuthorityHost')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('functionStorageName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2018-02-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'authsettings')]",
              "properties": {
                "enabled": true,
                "defaultProvider": "AzureActiveDirectory",
                "clientId": "[parameters('AADClientId')]",
                "issuer": "[format('{0}/v2.0', variables('oauthAuthority'))]",
                "allowedAudiences": [
                  "[parameters('AADClientId')]",
                  "[parameters('applicationIdUri')]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('functionServerfarmsName')]"
            },
            "functionEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName'))).hostNames[0]]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('functionStorageName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2019-10-01",
      "name": "simpleAuthWebAppDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "simpleAuthServerFarmsName": {
            "value": "[parameters('simpleAuth_serverFarmsName')]"
          },
          "simpleAuthWebAppName": {
            "value": "[parameters('simpleAuth_webAppName')]"
          },
          "sku": {
            "value": "[parameters('simpleAuth_sku')]"
          },
          "AADClientId": {
            "value": "[parameters('AADClientId')]"
          },
          "AADClientSecret": {
            "value": "[parameters('AADClientSecret')]"
          },
          "applicationIdUri": {
            "value": "[format('api://{0}/{1}', reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.domain.value, parameters('AADClientId'))]"
          },
          "frontendHostingStorageEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.endpoint.value]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.63.48766",
              "templateHash": "6977188566754266744"
            }
          },
          "parameters": {
            "sku": {
              "type": "string"
            },
            "simpleAuthServerFarmsName": {
              "type": "string"
            },
            "simpleAuthWebAppName": {
              "type": "string"
            },
            "tenantId": {
              "type": "string"
            },
            "AADClientId": {
              "type": "string"
            },
            "AADClientSecret": {
              "type": "secureString"
            },
            "applicationIdUri": {
              "type": "string"
            },
            "frontendHostingStorageEndpoint": {
              "type": "string"
            }
          },
          "functions": [],
          "variables": {
            "oauthAuthorityHost": "[environment().authentication.loginEndpoint]",
            "aadMetadataAddress": "[uri(variables('oauthAuthorityHost'), format('{0}/v2.0/.well-known/openid-configuration', parameters('tenantId')))]",
            "oauthAuthority": "[uri(variables('oauthAuthorityHost'), parameters('tenantId'))]",
            "teamsAadIds": "1fec8e78-bce4-4aaf-ab1b-5451cc387264;5e3ce6c0-2b1f-4285-8d4b-75ee78787346"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2020-06-01",
              "name": "[parameters('simpleAuthServerFarmsName')]",
              "location": "[resourceGroup().location]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "app",
              "properties": {
                "reserved": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2020-06-01",
              "name": "[parameters('simpleAuthWebAppName')]",
              "kind": "app",
              "location": "[resourceGroup().location]",
              "properties": {
                "reserved": false,
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('simpleAuthServerFarmsName'))]",
                "siteConfig": {
                  "alwaysOn": false,
                  "http20Enabled": false,
                  "numberOfWorkers": 1
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('simpleAuthServerFarmsName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2018-02-01",
              "name": "[format('{0}/{1}', parameters('simpleAuthWebAppName'), 'appsettings')]",
              "properties": {
                "AAD_METADATA_ADDRESS": "[variables('aadMetadataAddress')]",
                "ALLOWED_APP_IDS": "[variables('teamsAadIds')]",
                "IDENTIFIER_URI": "[parameters('applicationIdUri')]",
                "CLIENT_ID": "[parameters('AADClientId')]",
                "CLIENT_SECRET": "[parameters('AADClientSecret')]",
                "OAUTH_AUTHORITY": "[variables('oauthAuthority')]",
                "TAB_APP_ENDPOINT": "[parameters('frontendHostingStorageEndpoint')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('simpleAuthWebAppName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppName": {
              "type": "string",
              "value": "[parameters('simpleAuthWebAppName')]"
            },
            "skuName": {
              "type": "string",
              "value": "[parameters('sku')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('simpleAuthWebAppName'))).hostNames[0])]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy')]"
      ]
    }
  ],
  "outputs": {
    "frontendHosting_connectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.connectionString.value]"
    },
    "frontendHosting_storageName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.storageName.value]"
    },
    "frontendHosting_endpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.endpoint.value]"
    },
    "frontendHosting_domain": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'frontendHostingDeploy'), '2019-10-01').outputs.domain.value]"
    },
    "function_storageAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionDeploy'), '2019-10-01').outputs.storageAccountName.value]"
    },
    "function_appServicePlanName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionDeploy'), '2019-10-01').outputs.appServicePlanName.value]"
    },
    "function_functionEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'functionDeploy'), '2019-10-01').outputs.functionEndpoint.value]"
    },
    "simpleAuth_skuName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'simpleAuthWebAppDeploy'), '2019-10-01').outputs.skuName.value]"
    },
    "simpleAuth_endpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'simpleAuthWebAppDeploy'), '2019-10-01').outputs.endpoint.value]"
    }
  }
}